## Mojavez Agents Guide

این سند برای راهنمایی Agentها / LLMها در کار با این ریپو طراحی شده است.

### 1. ساختار کلی ریپو

- **لایه کراولر (Root)**
  - فایل‌های اصلی:
    - `crawler.py` (کلاس اصلی `MojavezCrawler` و منطق تماس با GraphQL)
    - `date_utils.py` (توابع تبدیل و پارس تاریخ مخصوص API)
    - `inspect_api.py`, `discover_schema.py`, `get_full_schema.py` (ابزارهای کمکی برای کشف و بررسی GraphQL schema)
    - `example_usage.py` (مثال‌های استفاده از کراولر)
    - `test_*.py` (تست‌ها یا اسکریپت‌های آزمایشی)
  - این لایه **نباید** به Django وابسته شود؛ یک کتابخانه/اسکریپت مستقل برای کراول است.

- **لایه پنل Django (`django_panel/`)**
  - پروژه Django: `django_panel/crawler_panel/`
    - `settings.py`, `urls.py`, `celery.py`, `asgi.py`, `wsgi.py`
  - اپ اصلی: `django_panel/jobs/`
    - `models.py` (مدل‌ها مثل `CrawlJob`, `CrawlRecord`)
    - `views.py`, `urls.py`, `serializers.py` (API و نمایش)
    - `tasks.py` (Celery tasks که از `crawler.MojavezCrawler` استفاده می‌کنند)
  - نقطه ورود:
    - `django_panel/manage.py` برای دستورات Django
    - اسکریپت‌های بات مثل `run_server.bat`, `manage_celery.bat` برای اجرا روی ویندوز

### 2. اصول کلی برای Agentها

- **تفکیک مسئولیت**
  - منطق کراول و GraphQL در لایه روت (`crawler.py` و فایل‌های کمکی) نگه داشته شود.
  - منطق UI/API، ذخیره‌سازی در دیتابیس و مدیریت Job در لایه Django (`django_panel/`) نگه داشته شود.
  - از وارد کردن (import) ماژول‌های Django در فایل‌های روت کراولر خودداری شود.

- **سبک کدنویسی**
  - کد Python را به صورت توابع و کلاس‌های کوچک، خوانا و تک‌مسئولیتی بنویس.
  - برای کلاس‌ها و توابع عمومی (به‌خصوص `MojavezCrawler`, Celery taskهای اصلی، viewهای مهم) داک‌استرینگ و/یا توضیح فارسی مشابه سبک فعلی اضافه یا به‌روزرسانی کن.
  - برای لاگ از `logging` استفاده کن، نه `print`. پیام‌های لاگ را کوتاه، واضح و در صورت نیاز با ایموجی/متن فارسی هماهنگ با کد فعلی نگه دار.
  - هیچ اطلاعات حساسی (توکن‌ها، پسورد، کوئری‌های محرمانه) را به صورت هاردکد داخل ریپو قرار نده.

- **مستندات و وابستگی‌ها**
  - اگر فیچر جدید اضافه می‌کنی:
    - در صورت نیاز بخش مرتبط در `README.md` یا READMEهای داخل `django_panel/` را به‌روزرسانی کن.
    - اگر به پکیج جدید نیاز است:
      - وابستگی‌های مربوط به کراولر را در `requirements.txt` (ریشه ریپو) اضافه کن.
      - وابستگی‌های مخصوص Django panel را در `django_panel/requirements.txt` اضافه کن.

### 3. سناریوهای متداول برای Agent

#### 3.1. افزودن قابلیت جدید به کراولر

- **کجا تغییر بدهیم؟**
  - منطق اصلی در `crawler.py` (کلاس `MojavezCrawler`) یا ماژول‌های کمکی کنارش (`date_utils.py`، اسکریپت‌های تست).
- **قوانین:**
  - اگر فیلتر/پارامتر/استراتژی جدیدی به GraphQL اضافه می‌کنی:
    - امضای متدها را واضح نگه دار و آرگومان‌ها را مستند کن.
    - در صورت پیچیده شدن منطق، آن را به توابع و متدهای کوچک‌تر بشکن.
  - مثال‌های استفاده را در `example_usage.py` به‌روزرسانی یا تکمیل کن، نه در خود کلاس اصلی.

#### 3.2. اضافه کردن API یا صفحه جدید در پنل Django

- **کجا تغییر بدهیم؟**
  - مدل جدید/ستون جدید: `django_panel/jobs/models.py`
  - API جدید یا view جدید: `django_panel/jobs/views.py` و ثبت مسیر در `django_panel/jobs/urls.py`
  - سریالایزر جدید: `django_panel/jobs/serializers.py`
- **قوانین:**
  - منطق تجاری را در مدل‌ها، سرویس‌ها یا tasks نگه دار، نه در viewها/URLها.
  - فقط از `crawler.MojavezCrawler` برای فراخوانی‌های شبکه‌ای استفاده کن، و نتیجه را در مدل‌های jobs ذخیره کن.

#### 3.3. افزودن یا تغییر Celery Task

- **کجا تغییر بدهیم؟**
  - همه taskها در `django_panel/jobs/tasks.py` تعریف می‌شوند.
  - تنظیمات Celery در `django_panel/crawler_panel/celery.py` است.
- **قوانین:**
  - از `shared_task` استفاده کن و signature را واضح و مستند بنویس.
  - برای اجرای کراول از `MojavezCrawler` استفاده کن؛ توابع کمکی تاریخ از `date_utils.py` استفاده شوند.
  - به‌روزرسانی وضعیت Job و ذخیره رکوردها باید از طریق مدل‌های `CrawlJob` و `CrawlRecord` و با استفاده از تراکنش‌ها (`transaction.atomic`) انجام شود.

### 4. فایل‌های تولید‌شده و غیرسورس

Agentها **نباید** این فایل‌ها را ویرایش کنند یا بر اساس ساختارشان طراحی انجام دهند:

- لاگ‌ها و دیتابیس‌های محلی:
  - `**/*.log`
  - `**/*.sqlite3`
- فایل‌های اسکیما و خروجی GraphQL:
  - `graphql_schema.json`
  - `graphql_full_schema.json`
  - `schema_partial.json`
  - `records_*.json`
  - `example_output.json`
  - `tehran_records.json`

اگر نیاز به به‌روزرسانی این‌ها بود، با اجرای اسکریپت‌های مربوطه (`get_full_schema.py`, `inspect_api.py`, `crawler.py`, Celery tasks و غیره) آن‌ها را دوباره تولید کن.

### 5. نکات تکمیلی برای Agentها

- قبل از انجام تغییرات بزرگ، به ساختار فعلی و کامنت‌های فارسی دقت کن و همان سبک را ادامه بده.
- در فیچرهایی که هم کراولر و هم پنل Django را درگیر می‌کنند:
  - ابتدا منطق خام کراول و API را در لایه کراولر پیاده‌سازی یا اصلاح کن.
  - سپس مصرف آن را در لایه Django اضافه کن (tasks/models/views).
- اگر درباره محل مناسب برای کدی مردد شدی:
  - کدی که به GraphQL endpoint و استراتژی دریافت داده وابسته است → لایه کراولر.
  - کدی که به دیتابیس Django، مدل‌ها، user interface یا API داخلی پروژه مربوط است → لایه Django (`django_panel`).

